import{H as I,p as G,D as ee,l as te,r as o,y as ae,E as ne,w as se,f as z,G as C,K as U,L as ie,M as re,o as l,a as le,j as e,N as R,O as Y,W as H,P as ce,T as de,c as oe,C as me,k as ue}from"./vendor-DZp4qUgB.js";import{d as g}from"./bignumber-L0kgG1Q3.js";import"./lodash-C-76dkfd.js";import{c as v,a as F}from"./react-app-DjWCPCj7.js";const ye=({open:x,setOpen:b,spaceInfo:t,language:r,refreshSpace:S})=>{var O;const{address:$}=G(),{network:E}=ee(),c=G();te();const[m,V]=o.useState([]),[h,Q]=o.useState([]),{pendingTransactionsArray:M}=ae(),{failedTransactionsArray:w}=ne(),{successfulTransactionsArray:k}=se();z.useRef(null);const y=a=>{if(!a[1].transactions)return!1;const s=l.Transaction.fromPlainObject(a[1].transactions[0]);if(s.getReceiver().bech32()===F){let i=l.TransactionPayload.fromEncoded(s.getData().encoded()).getEncodedArguments();if(i.length===5){if(i[3]===new l.ArgSerializer().valuesToString([new l.StringValue("buySpace")]).argumentsString&&i[4]===new l.ArgSerializer().valuesToString([new l.StringValue(t.name)]).argumentsString)return!0}else if(i.length>0&&i[0]==="buySpace"&&i[1]===new l.ArgSerializer().valuesToString([new l.StringValue(t.name)]).argumentsString)return!0}return!1},q=o.useMemo(()=>M.some(y),[M]),W=o.useMemo(()=>w.some(y),[w]),P=o.useMemo(()=>k.some(y),[k]),N=o.useMemo(()=>w.find(y),[w]),J=o.useMemo(()=>{let a=t!=null&&t.is_new?(t==null?void 0:t.paid_amount)||7:((t==null?void 0:t.paid_amount)==null?7:t.paid_amount)*2;(c==null?void 0:c.address)==v&&(a=0);const s=r=="en"?`Value must be greater than or equal to ${a}.`:`Valoarea trebuie să fie mai mare sau egală cu ${a}.`;return C().required("Required").test("minimum",s,(n="0")=>new g(U(n,6)).isGreaterThanOrEqualTo(new g(U(`${a}`,6))))},[t,m]);o.useEffect(()=>{if(S&&P){const a=k.filter(y);for(const s of a)ie(s[0]);S(),b(!1)}},[P,S]);const[B,D]=o.useState(!1),[L,T]=o.useState(!1);o.useEffect(()=>{x&&(async()=>{try{D(!0);const a=await new re.ApiNetworkProvider(E.apiAddress).queryContract(new l.SmartContract({address:l.Address.fromBech32(F)}).createQuery({func:new l.ContractFunction("getAcceptedTokens")}));if(a.returnCode=="ok"){let s=a.returnData.map(n=>atob(n));Q(s)}}catch{}D(!1)})()},[x]),o.useEffect(()=>{x&&(async()=>{try{T(!0);const{data:a}=await le.get(`${E.apiAddress}/accounts/${$}/tokens`);if(!a||a.length===0){V([]),T(!1);return}const s=h.map(n=>({token:n,balance:new g(0)}));for(const n of a)if(h.includes(n.identifier)){const i=h.indexOf(n.identifier);s[i].balance=new g(n.balance)}V(s)}catch{}T(!1)})()},[$,h]);const X=async(a,s)=>{if((c==null?void 0:c.address)!==v){if(m.length===0)return;const p=h.indexOf(a);if(p===-1||m[p].balance.isLessThan(s))return}const n=new l.ArgSerializer;let i="ESDTTransfer";i+="@"+n.valuesToString([new l.StringValue(a)]).argumentsString,i+="@"+n.valuesToString([new l.BigUIntValue(s)]).argumentsString,i+="@"+n.valuesToString([new l.StringValue("buySpace")]).argumentsString,i+="@"+n.valuesToString([new l.StringValue(t.name)]).argumentsString,(c==null?void 0:c.address)==v&&(i="buySpace@"+n.valuesToString([new l.StringValue(t.name)]).argumentsString);const j={value:"0",data:i,receiver:F,gasLimit:"60000000"};await me();const{sessionId:f}=await ue({transactions:j,transactionsDisplayInfo:{processingMessage:r=="en"?"Processing space rental transaction":"Procesare tranzacție închiriere spațiu",errorMessage:r=="en"?"Space rental transaction failed":"Tranzacție închiriere spațiu eșuată",successMessage:r=="en"?"You now own this space for 30 days":"Acum deții acest spațiu pentru 30 de zile"},redirectAfterSign:!1})},Z=a=>{const s=/_[0-9]+_/g,n=a.match(s);if(n)for(const i of n){const j=i.replace(/_/g,""),f=K(j,{denomination:6});a=a.replace(i,f)}return a=a.replace("(/10^6) ",""),a},A="rounded-lg px-4 pt-5 pb-4 sm:p-6 ";return e.jsx(R.Root,{show:x,as:"div",children:e.jsx(Y,{as:"div",className:"fixed z-10 inset-0 overflow-y-auto",open:x,onClose:a=>{b(!1)},children:e.jsxs("div",{className:"flex items-start justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0",children:[e.jsx(R.Child,{as:z.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx(Y.Overlay,{className:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"})}),e.jsx("span",{className:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true",children:"​"}),e.jsx(R.Child,{as:z.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95",enterTo:"opacity-100 translate-y-0 sm:scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 translate-y-0 sm:scale-100",leaveTo:"opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95",children:e.jsxs("div",{className:"inline-block align-bottom bg-white text-left shadow-xl transform transition-all sm:mt-32 sm:align-middle sm:max-w-sm sm:w-full w-full md:max-w-md lg:max-w-lg xl:max-w-[55rem] relative",children:[q&&e.jsx("div",{className:`w-full h-full ${A} bg-white bg-opacity-50 flex items-center justify-center`,children:e.jsx("div",{className:"flex flex-col items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(H,{noText:!0,className:"p-0"}),e.jsx("p",{className:"text-lg font-bold mb-0",children:r=="en"?"Pending rent transaction":"Tranzacție închiriere în curs"}),e.jsx("p",{className:"text-sm text-gray-500",children:r=="en"?"Please wait for the transaction to complete":"Așteaptă finalizarea tranzacției"})]})})}),(B||L)&&e.jsx("div",{className:`w-full h-full ${A} bg-white bg-opacity-50 flex items-center justify-center`,children:e.jsx("div",{className:"flex flex-col items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(H,{noText:!0,className:"p-0"}),e.jsx("p",{className:"text-lg font-bold mb-0",children:r=="en"?"Loading required data from the blockchain":"Încărcare date necesare de pe blockchain"}),e.jsx("p",{className:"text-sm text-gray-500",children:r=="en"?"Checking your account balance and accepted tokens":"Verificare sold cont și tokenuri acceptate"})]})})}),!(B||L)&&!q&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-splash px-4 py-3 text-white font-bold flex items-center justify-between",children:[e.jsx("div",{children:r=="en"?"Rent space for 10 days":"Închiriază spațiu pentru 10 zile"}),e.jsx("div",{children:e.jsx("button",{type:"button",className:"text-2xl",onClick:()=>{b(!1)},children:"×"})})]}),e.jsx("div",{className:`${A}`,children:e.jsx(ce,{validationSchema:de().shape({token:(c==null?void 0:c.address)===v?C().nullable():C().required("Required"),amount:J}),onSubmit:a=>{X(a.token,new g(a.amount).multipliedBy(new g(10).pow(6)))},initialValues:{token:m.length>=1&&((O=m==null?void 0:m.find(a=>a.balance.gt(0)))==null?void 0:O.token)||"",amount:t!=null&&t.is_new?(t==null?void 0:t.paid_amount)||7:t.paid_amount*2},children:({errors:a,values:s,touched:n,handleChange:i,handleBlur:j,handleSubmit:f,setFieldValue:p})=>{var _;return(!m.length||!m.some(d=>d.balance.gt(0)))&&(c==null?void 0:c.address)!==v?e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg font-bold",children:r=="en"?"No tokens available":"Nu există token-uri disponibile"}),e.jsx("p",{className:"text-sm text-gray-500",children:r=="en"?"You need to have at least one of the following tokens in your wallet to rent this space:":"Ai nevoie de cel puțin unul dintre următoarele token-uri în portofel pentru a închiria acest spațiu:"}),e.jsx("ul",{className:"text-sm text-gray-500",children:h.map((d,u)=>e.jsx("li",{children:d},u))}),e.jsxs("p",{className:"text-sm text-gray-500",children:[r=="en"?"The minimumm amount to rent this space is ":"Suma minimă pentru închiriere este ",t!=null&&t.is_new?(t==null?void 0:t.paid_amount)||7:t.paid_amount*2,"."]})]}):e.jsxs(e.Fragment,{children:[W&&e.jsx("div",{className:"w-full h-full bg-red-500 bg-opacity-50 flex items-center justify-center mb-4 p-4",children:e.jsx("div",{className:"flex flex-col items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg font-bold mb-0",children:r=="en"?"Rent transaction failed":"Tranzacție închiriere eșuată"}),e.jsx("p",{className:"text-sm",children:r=="en"?"Check that you have enough balance and try again. For more information, check the blockchain explorer.":"Verifică dacă ai suficientă balanță și încearcă din nou. Pentru mai multe informații, verifică explorer-ul blockchain-ului."}),N&&((_=N[1])==null?void 0:_.errorMessage)&&e.jsxs("p",{className:"text-xs mt-2",children:["Smart Contract error: ",e.jsx("br",{}),Z(N[1].errorMessage)]})]})})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{children:e.jsx("label",{htmlFor:"token",className:"text-sm text-gray-500",children:r=="en"?"Select token":"Selectează token"})}),e.jsx("div",{children:e.jsxs("select",{name:"token",id:"token",className:"d-select d-select-primary w-full max-w-xs",value:s.token,onChange:d=>{p("token",d.target.value)},children:[e.jsx("option",{value:"",children:r=="en"?"Select token":"Selectează token"}),m.map((d,u)=>d.balance.eq(0)?null:e.jsxs("option",{value:d.token,selected:s.token===d.token,children:[d.token,"(",K(d.balance.toString()),")"]},u))]})}),a.token&&e.jsx("div",{className:"text-red-500 text-xs mt-1",children:a.token})]}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsxs("label",{htmlFor:"token",className:"text-sm text-gray-500",children:[r=="en"?"Amount":"Sumă"," (min. ",t!=null&&t.is_new?(t==null?void 0:t.paid_amount)||7:t.paid_amount*2," USD)"]})}),e.jsx("div",{children:e.jsx("input",{type:"number",id:"amount",name:"amount",step:"any",required:!0,autoComplete:"off",min:t!=null&&t.is_new?t.paid_amount||7:t.paid_amount*2,className:oe("d-input d-input-bordered d-input-primary w-full max-w-xs",{invalid:a.amount&&n.amount}),value:s.amount,onBlur:j,onChange:d=>{let u=d.target.value;u.indexOf(",")>-1&&(u=u.replace(",",".")),console.log({val:u,target:d.target}),p("amount",u)}})}),a.amount&&n.amount&&e.jsx("div",{className:"text-red-500 text-xs mt-1",children:a.amount})]})]}),e.jsx("div",{className:"mt-4 pb-4",children:e.jsx("button",{onClick:f,className:"d-btn d-btn-primary",type:"submit",children:r=="en"?"Rent":"Închiriază"})})]})}})})]})]})})]})})})},K=(x,b)=>I({input:x,decimals:6,...b});export{ye as BuySpace,ye as default,K as denominated};
