import{c as f,b as F,j as t,a as l,F as U}from"./react-app-DdKy85kH.js";import{H as te,p as Y,D as ae,l as ne,r as m,y as ie,E as re,w as se,f as R,G as $,K as H,L as le,M as ce,o as c,a as de,N as j,O as K,W as Q,P as oe,T as me,c as ue,C as he,k as ge}from"./vendor-DZp4qUgB.js";import{d as b}from"./bignumber-L0kgG1Q3.js";import"./lodash-C-76dkfd.js";const ve=({open:g,setOpen:y,spaceInfo:e,language:s,refreshSpace:N})=>{var G;const{address:E}=Y(),{network:V}=ae(),d=Y();ne();const[u,M]=m.useState([]),[x,J]=m.useState([]),{pendingTransactionsArray:q}=ie(),{failedTransactionsArray:S}=re(),{successfulTransactionsArray:T}=se();R.useRef(null);const p=a=>{if(!a[1].transactions)return!1;const i=c.Transaction.fromPlainObject(a[1].transactions[0]);if(i.getReceiver().bech32()===F){let r=c.TransactionPayload.fromEncoded(i.getData().encoded()).getEncodedArguments();if(r.length===5){if(r[3]===new c.ArgSerializer().valuesToString([new c.StringValue("buySpace")]).argumentsString&&r[4]===new c.ArgSerializer().valuesToString([new c.StringValue(e.name)]).argumentsString)return!0}else if(r.length>0&&r[0]==="buySpace"&&r[1]===new c.ArgSerializer().valuesToString([new c.StringValue(e.name)]).argumentsString)return!0}return!1},P=m.useMemo(()=>q.some(p),[q]),X=m.useMemo(()=>S.some(p),[S]),B=m.useMemo(()=>T.some(p),[T]),A=m.useMemo(()=>S.find(p),[S]),Z=m.useMemo(()=>{let a=e!=null&&e.is_new?(e==null?void 0:e.paid_amount)||7:((e==null?void 0:e.paid_amount)==null?7:e.paid_amount)*2;(d==null?void 0:d.address)==f&&(a=0);const i=s=="en"?`Value must be greater than or equal to ${a}.`:`Valoarea trebuie să fie mai mare sau egală cu ${a}.`;return $().required("Required").test("minimum",i,(n="0")=>new b(H(n,6)).isGreaterThanOrEqualTo(new b(H(`${a}`,6))))},[e,u]);m.useEffect(()=>{if(N&&B){const a=T.filter(p);for(const i of a)le(i[0]);N(),y(!1)}},[B,N]);const[D,L]=m.useState(!1),[O,_]=m.useState(!1);m.useEffect(()=>{g&&(async()=>{try{L(!0);const a=await new ce.ApiNetworkProvider(V.apiAddress).queryContract(new c.SmartContract({address:c.Address.fromBech32(F)}).createQuery({func:new c.ContractFunction("getAcceptedTokens")}));if(a.returnCode=="ok"){let i=a.returnData.map(n=>atob(n));J(i)}}catch{}L(!1)})()},[g]),m.useEffect(()=>{g&&(async()=>{try{_(!0);const{data:a}=await de.get(`${V.apiAddress}/accounts/${E}/tokens`);if(!a||a.length===0){M([]),_(!1);return}const i=x.map(n=>({token:n,balance:new b(0)}));for(const n of a)if(x.includes(n.identifier)){const r=x.indexOf(n.identifier);i[r].balance=new b(n.balance)}M(i)}catch{}_(!1)})()},[E,x]);const I=async(a,i)=>{if((d==null?void 0:d.address)!==f){if(u.length===0)return;const w=x.indexOf(a);if(w===-1||u[w].balance.isLessThan(i))return}const n=new c.ArgSerializer;let r="ESDTTransfer";r+="@"+n.valuesToString([new c.StringValue(a)]).argumentsString,r+="@"+n.valuesToString([new c.BigUIntValue(i)]).argumentsString,r+="@"+n.valuesToString([new c.StringValue("buySpace")]).argumentsString,r+="@"+n.valuesToString([new c.StringValue(e.name)]).argumentsString,(d==null?void 0:d.address)==f&&(r="buySpace@"+n.valuesToString([new c.StringValue(e.name)]).argumentsString);const v={value:"0",data:r,receiver:F,gasLimit:"60000000"};await he();const{sessionId:k}=await ge({transactions:v,transactionsDisplayInfo:{processingMessage:s=="en"?"Processing space rental transaction":"Procesare tranzacție închiriere spațiu",errorMessage:s=="en"?"Space rental transaction failed":"Tranzacție închiriere spațiu eșuată",successMessage:s=="en"?"You now own this space for 30 days":"Acum deții acest spațiu pentru 30 de zile"},redirectAfterSign:!1})},ee=a=>{const i=/_[0-9]+_/g,n=a.match(i);if(n)for(const r of n){const v=r.replace(/_/g,""),k=W(v,{denomination:6});a=a.replace(r,k)}return a=a.replace("(/10^6) ",""),a},z="rounded-lg px-4 pt-5 pb-4 sm:p-6 ";return t(j.Root,{show:g,as:"div",children:t(K,{as:"div",className:"fixed z-10 inset-0 overflow-y-auto",open:g,onClose:a=>{y(!1)},children:l("div",{className:"flex items-start justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0",children:[t(j.Child,{as:R.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:t(K.Overlay,{className:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"})}),t("span",{className:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true",children:"​"}),t(j.Child,{as:R.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95",enterTo:"opacity-100 translate-y-0 sm:scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 translate-y-0 sm:scale-100",leaveTo:"opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95",children:l("div",{className:"inline-block align-bottom bg-white text-left shadow-xl transform transition-all sm:mt-32 sm:align-middle sm:max-w-sm sm:w-full w-full md:max-w-md lg:max-w-lg xl:max-w-[55rem] relative",children:[P&&t("div",{className:`w-full h-full ${z} bg-white bg-opacity-50 flex items-center justify-center`,children:t("div",{className:"flex flex-col items-center justify-center",children:l("div",{className:"text-center",children:[t(Q,{noText:!0,className:"p-0"}),t("p",{className:"text-lg font-bold mb-0",children:s=="en"?"Pending rent transaction":"Tranzacție închiriere în curs"}),t("p",{className:"text-sm text-gray-500",children:s=="en"?"Please wait for the transaction to complete":"Așteaptă finalizarea tranzacției"})]})})}),(D||O)&&t("div",{className:`w-full h-full ${z} bg-white bg-opacity-50 flex items-center justify-center`,children:t("div",{className:"flex flex-col items-center justify-center",children:l("div",{className:"text-center",children:[t(Q,{noText:!0,className:"p-0"}),t("p",{className:"text-lg font-bold mb-0",children:s=="en"?"Loading required data from the blockchain":"Încărcare date necesare de pe blockchain"}),t("p",{className:"text-sm text-gray-500",children:s=="en"?"Checking your account balance and accepted tokens":"Verificare sold cont și tokenuri acceptate"})]})})}),!(D||O)&&!P&&l(U,{children:[l("div",{className:"bg-splash px-4 py-3 text-white font-bold flex items-center justify-between",children:[t("div",{children:s=="en"?"Rent space for 10 days":"Închiriază spațiu pentru 10 zile"}),t("div",{children:t("button",{type:"button",className:"text-2xl",onClick:()=>{y(!1)},children:"×"})})]}),t("div",{className:`${z}`,children:t(oe,{validationSchema:me().shape({token:(d==null?void 0:d.address)===f?$().nullable():$().required("Required"),amount:Z}),onSubmit:a=>{I(a.token,new b(a.amount).multipliedBy(new b(10).pow(6)))},initialValues:{token:u.length>=1&&((G=u==null?void 0:u.find(a=>a.balance.gt(0)))==null?void 0:G.token)||"",amount:e!=null&&e.is_new?(e==null?void 0:e.paid_amount)||7:e.paid_amount*2},children:({errors:a,values:i,touched:n,handleChange:r,handleBlur:v,handleSubmit:k,setFieldValue:w})=>{var C;return(!u.length||!u.some(o=>o.balance.gt(0)))&&(d==null?void 0:d.address)!==f?l("div",{className:"text-center",children:[t("p",{className:"text-lg font-bold",children:s=="en"?"No tokens available":"Nu există token-uri disponibile"}),t("p",{className:"text-sm text-gray-500",children:s=="en"?"You need to have at least one of the following tokens in your wallet to rent this space:":"Ai nevoie de cel puțin unul dintre următoarele token-uri în portofel pentru a închiria acest spațiu:"}),t("ul",{className:"text-sm text-gray-500",children:x.map((o,h)=>t("li",{children:o},h))}),l("p",{className:"text-sm text-gray-500",children:[s=="en"?"The minimumm amount to rent this space is ":"Suma minimă pentru închiriere este ",e!=null&&e.is_new?(e==null?void 0:e.paid_amount)||7:e.paid_amount*2,"."]})]}):l(U,{children:[X&&t("div",{className:"w-full h-full bg-red-500 bg-opacity-50 flex items-center justify-center mb-4 p-4",children:t("div",{className:"flex flex-col items-center justify-center",children:l("div",{className:"text-center",children:[t("p",{className:"text-lg font-bold mb-0",children:s=="en"?"Rent transaction failed":"Tranzacție închiriere eșuată"}),t("p",{className:"text-sm",children:s=="en"?"Check that you have enough balance and try again. For more information, check the blockchain explorer.":"Verifică dacă ai suficientă balanță și încearcă din nou. Pentru mai multe informații, verifică explorer-ul blockchain-ului."}),A&&((C=A[1])==null?void 0:C.errorMessage)&&l("p",{className:"text-xs mt-2",children:["Smart Contract error: ",t("br",{}),ee(A[1].errorMessage)]})]})})}),l("div",{className:"grid gap-4 md:grid-cols-2",children:[l("div",{children:[t("div",{children:t("label",{htmlFor:"token",className:"text-sm text-gray-500",children:s=="en"?"Select token":"Selectează token"})}),t("div",{children:l("select",{name:"token",id:"token",className:"d-select d-select-primary w-full max-w-xs",value:i.token,onChange:o=>{w("token",o.target.value)},children:[t("option",{value:"",children:s=="en"?"Select token":"Selectează token"}),u.map((o,h)=>o.balance.eq(0)?null:l("option",{value:o.token,selected:i.token===o.token,children:[o.token,"(",W(o.balance.toString()),")"]},h))]})}),a.token&&t("div",{className:"text-red-500 text-xs mt-1",children:a.token})]}),l("div",{children:[t("div",{children:l("label",{htmlFor:"token",className:"text-sm text-gray-500",children:[s=="en"?"Amount":"Sumă"," (min. ",e!=null&&e.is_new?(e==null?void 0:e.paid_amount)||7:e.paid_amount*2," USD)"]})}),t("div",{children:t("input",{type:"number",id:"amount",name:"amount",step:"any",required:!0,autoComplete:"off",min:e!=null&&e.is_new?e.paid_amount||7:e.paid_amount*2,className:ue("d-input d-input-bordered d-input-primary w-full max-w-xs",{invalid:a.amount&&n.amount}),value:i.amount,onBlur:v,onChange:o=>{let h=o.target.value;h.indexOf(",")>-1&&(h=h.replace(",",".")),console.log({val:h,target:o.target}),w("amount",h)}})}),a.amount&&n.amount&&t("div",{className:"text-red-500 text-xs mt-1",children:a.amount})]})]}),t("div",{className:"mt-4 pb-4",children:t("button",{onClick:k,className:"d-btn d-btn-primary",type:"submit",children:s=="en"?"Rent":"Închiriază"})})]})}})})]})]})})]})})})},W=(g,y)=>te({input:g,decimals:6,...y});export{ve as BuySpace,ve as default,W as denominated};
