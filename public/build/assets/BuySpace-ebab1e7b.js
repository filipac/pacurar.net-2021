import{c as k,b as R,j as t,a as s,F as Y}from"./react-app-15524a71.js";import{m as G,C as ae,f as ne,c as d,t as ie,D as re,s as se,R as C,E as F,F as K,K as le,L as ce,o as l,a as oe,M as j,N as H,O as J,P as de,Q as me,y as ue,_ as he,T as ge,B as xe}from"./vendor-271676b3.js";import"./lodash-87d1c6bb.js";import{h as f}from"./bignumber-d824444f.js";const we=({open:b,setOpen:v,spaceInfo:e,language:r,refreshSpace:N})=>{var Q;const{address:V}=G(),{network:$}=ae(),m=G();ne();const[u,E]=d.useState([]),[y,X]=d.useState([]),{pendingTransactionsArray:M}=ie(),{failedTransactionsArray:p}=re(),{successfulTransactionsArray:T}=se(),q=C.useRef(null),w=a=>{if(!a[1].transactions)return!1;const n=l.Transaction.fromPlainObject(a[1].transactions[0]);if(n.getReceiver().bech32()===R){let o=l.TransactionPayload.fromEncoded(n.getData().encoded()).getEncodedArguments();if(o.length===5){if(o[3]===new l.ArgSerializer().valuesToString([new l.StringValue("buySpace")]).argumentsString&&o[4]===new l.ArgSerializer().valuesToString([new l.StringValue(e.name)]).argumentsString)return!0}else if(o.length>0&&o[0]==="buySpace"&&o[1]===new l.ArgSerializer().valuesToString([new l.StringValue(e.name)]).argumentsString)return!0}return!1},P=d.useMemo(()=>M.some(w),[M]),Z=d.useMemo(()=>p.some(w),[p]),B=d.useMemo(()=>T.some(w),[T]),A=d.useMemo(()=>p.find(w),[p]),I=d.useMemo(()=>{let a=e!=null&&e.is_new?(e==null?void 0:e.paid_amount)||7:((e==null?void 0:e.paid_amount)==null?7:e.paid_amount)*2;(m==null?void 0:m.address)==k&&(a=0);const n=r=="en"?`Value must be greater than or equal to ${a}.`:`Valoarea trebuie să fie mai mare sau egală cu ${a}.`;return F().required("Required").test("minimum",n,(i="0")=>new f(K(i,6)).isGreaterThanOrEqualTo(new f(K(`${a}`,6))))},[e,u]);d.useEffect(()=>{if(N&&B){const a=T.filter(w);for(const n of a)le(n[0]);N(),v(!1)}},[B,N]);const[D,L]=d.useState(!1),[O,_]=d.useState(!1);d.useEffect(()=>{b&&(async()=>{try{L(!0);const a=await new ce.ApiNetworkProvider($.apiAddress).queryContract(new l.SmartContract({address:l.Address.fromBech32(R)}).createQuery({func:new l.ContractFunction("getAcceptedTokens")}));if(a.returnCode=="ok"){let n=a.returnData.map(i=>atob(i));X(n)}}catch{}L(!1)})()},[b]),d.useEffect(()=>{b&&(async()=>{try{_(!0);const{data:a}=await oe.get(`${$.apiAddress}/accounts/${V}/tokens`);if(!a||a.length===0){E([]),_(!1);return}const n=y.map(i=>({token:i,balance:new f(0)}));for(const i of a)if(y.includes(i.identifier)){const o=y.indexOf(i.identifier);n[o].balance=new f(i.balance)}E(n)}catch{}_(!1)})()},[V,y]);const ee=async(a,n)=>{if(u.length===0)return;const i=y.indexOf(a);if(i===-1||u[i].balance.isLessThan(n))return;const g=new l.ArgSerializer;let h="ESDTTransfer";h+="@"+g.valuesToString([new l.StringValue(a)]).argumentsString,h+="@"+g.valuesToString([new l.BigUIntValue(n)]).argumentsString,h+="@"+g.valuesToString([new l.StringValue("buySpace")]).argumentsString,h+="@"+g.valuesToString([new l.StringValue(e.name)]).argumentsString,(m==null?void 0:m.address)==k&&(h="buySpace@"+g.valuesToString([new l.StringValue(e.name)]).argumentsString);const S={value:"0",data:h,receiver:R,gasLimit:"60000000"};await ge(),await xe({transactions:S,transactionsDisplayInfo:{processingMessage:r=="en"?"Processing space rental transaction":"Procesare tranzacție închiriere spațiu",errorMessage:r=="en"?"Space rental transaction failed":"Tranzacție închiriere spațiu eșuată",successMessage:r=="en"?"You now own this space for 30 days":"Acum deții acest spațiu pentru 30 de zile"},redirectAfterSign:!1})},te=a=>{const n=/_[0-9]+_/g,i=a.match(n);if(i)for(const o of i){const g=o.replace(/_/g,""),h=W(g,{denomination:6});a=a.replace(o,h)}return a=a.replace("(/10^6) ",""),a},z="rounded-lg px-4 pt-5 pb-4 sm:p-6 ";return d.useEffect(()=>{console.log({formikRef:q.current})},[q.current,e]),t(j.Root,{show:b,as:"div",children:t(H,{as:"div",className:"fixed z-10 inset-0 overflow-y-auto",open:b,onClose:a=>{v(!1)},children:s("div",{className:"flex items-start justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0",children:[t(j.Child,{as:C.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:t(H.Overlay,{className:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"})}),t("span",{className:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true",children:"​"}),t(j.Child,{as:C.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95",enterTo:"opacity-100 translate-y-0 sm:scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 translate-y-0 sm:scale-100",leaveTo:"opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95",children:s("div",{className:"inline-block align-bottom bg-white text-left shadow-xl transform transition-all sm:mt-32 sm:align-middle sm:max-w-sm sm:w-full w-full md:max-w-md lg:max-w-lg xl:max-w-[55rem] relative",children:[P&&t("div",{className:`w-full h-full ${z} bg-white bg-opacity-50 flex items-center justify-center`,children:t("div",{className:"flex flex-col items-center justify-center",children:s("div",{className:"text-center",children:[t(J,{noText:!0,className:"p-0"}),t("p",{className:"text-lg font-bold mb-0",children:r=="en"?"Pending rent transaction":"Tranzacție închiriere în curs"}),t("p",{className:"text-sm text-gray-500",children:r=="en"?"Please wait for the transaction to complete":"Așteaptă finalizarea tranzacției"})]})})}),(D||O)&&t("div",{className:`w-full h-full ${z} bg-white bg-opacity-50 flex items-center justify-center`,children:t("div",{className:"flex flex-col items-center justify-center",children:s("div",{className:"text-center",children:[t(J,{noText:!0,className:"p-0"}),t("p",{className:"text-lg font-bold mb-0",children:r=="en"?"Loading required data from the blockchain":"Încărcare date necesare de pe blockchain"}),t("p",{className:"text-sm text-gray-500",children:r=="en"?"Checking your account balance and accepted tokens":"Verificare sold cont și tokenuri acceptate"})]})})}),!(D||O)&&!P&&s(Y,{children:[s("div",{className:"bg-splash px-4 py-3 text-white font-bold flex items-center justify-between",children:[t("div",{children:r=="en"?"Rent space for 10 days":"Închiriază spațiu pentru 10 zile"}),t("div",{children:t("button",{type:"button",className:"text-2xl",onClick:()=>{v(!1)},children:"×"})})]}),t("div",{className:`${z}`,children:t(de,{validationSchema:me().shape({token:(m==null?void 0:m.address)===k?F().nullable():F().required("Required"),amount:I}),onSubmit:a=>{ee(a.token,new f(a.amount).multipliedBy(new f(10).pow(6)))},initialValues:{token:u.length>=1&&((Q=u==null?void 0:u.find(a=>a.balance.gt(0)))==null?void 0:Q.token)||"",amount:e!=null&&e.is_new?(e==null?void 0:e.paid_amount)||7:e.paid_amount*2},children:({errors:a,values:n,touched:i,handleChange:o,handleBlur:g,handleSubmit:h,setFieldValue:S})=>{var U;return(!u.length||!u.some(c=>c.balance.gt(0)))&&(m==null?void 0:m.address)!==k?s("div",{className:"text-center",children:[t("p",{className:"text-lg font-bold",children:r=="en"?"No tokens available":"Nu există token-uri disponibile"}),t("p",{className:"text-sm text-gray-500",children:r=="en"?"You need to have at least one of the following tokens in your wallet to rent this space:":"Ai nevoie de cel puțin unul dintre următoarele token-uri în portofel pentru a închiria acest spațiu:"}),t("ul",{className:"text-sm text-gray-500",children:y.map((c,x)=>t("li",{children:c},x))}),s("p",{className:"text-sm text-gray-500",children:[r=="en"?"The minimumm amount to rent this space is ":"Suma minimă pentru închiriere este ",e!=null&&e.is_new?(e==null?void 0:e.paid_amount)||7:e.paid_amount*2,"."]})]}):s(Y,{children:[Z&&t("div",{className:"w-full h-full bg-red-500 bg-opacity-50 flex items-center justify-center mb-4 p-4",children:t("div",{className:"flex flex-col items-center justify-center",children:s("div",{className:"text-center",children:[t("p",{className:"text-lg font-bold mb-0",children:r=="en"?"Rent transaction failed":"Tranzacție închiriere eșuată"}),t("p",{className:"text-sm",children:r=="en"?"Check that you have enough balance and try again. For more information, check the blockchain explorer.":"Verifică dacă ai suficientă balanță și încearcă din nou. Pentru mai multe informații, verifică explorer-ul blockchain-ului."}),A&&((U=A[1])==null?void 0:U.errorMessage)&&s("p",{className:"text-xs mt-2",children:["Smart Contract error: ",t("br",{}),te(A[1].errorMessage)]})]})})}),s("div",{className:"grid gap-4 md:grid-cols-2",children:[s("div",{children:[t("div",{children:t("label",{htmlFor:"token",className:"text-sm text-gray-500",children:r=="en"?"Select token":"Selectează token"})}),t("div",{children:s("select",{name:"token",id:"token",className:"d-select d-select-primary w-full max-w-xs",value:n.token,onChange:c=>{S("token",c.target.value)},children:[t("option",{value:"",children:r=="en"?"Select token":"Selectează token"}),u.map((c,x)=>c.balance.eq(0)?null:s("option",{value:c.token,selected:n.token===c.token,children:[c.token,"(",W(c.balance.toString()),")"]},x))]})}),a.token&&t("div",{className:"text-red-500 text-xs mt-1",children:a.token})]}),s("div",{children:[t("div",{children:s("label",{htmlFor:"token",className:"text-sm text-gray-500",children:[r=="en"?"Amount":"Sumă"," (min. ",e!=null&&e.is_new?(e==null?void 0:e.paid_amount)||7:e.paid_amount*2," USD)"]})}),t("div",{children:t("input",{type:"number",id:"amount",name:"amount",step:"any",required:!0,autoComplete:"off",min:e!=null&&e.is_new?e.paid_amount||7:e.paid_amount*2,className:ue("d-input d-input-bordered d-input-primary w-full max-w-xs",{invalid:a.amount&&i.amount}),value:n.amount,onBlur:g,onChange:c=>{let x=c.target.value;x.indexOf(",")>-1&&(x=x.replace(",",".")),console.log({val:x,target:c.target}),S("amount",x)}})}),a.amount&&i.amount&&t("div",{className:"text-red-500 text-xs mt-1",children:a.amount})]})]}),t("div",{className:"mt-4 pb-4",children:t("button",{onClick:h,className:"d-btn d-btn-primary",type:"submit",children:r=="en"?"Rent":"Închiriază"})})]})}})})]})]})})]})})})},W=(b,v)=>he({input:b,denomination:6,decimals:6,...v});export{we as BuySpace,we as default,W as denominated};
